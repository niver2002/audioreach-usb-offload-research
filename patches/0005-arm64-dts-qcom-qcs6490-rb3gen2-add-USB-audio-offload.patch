From: USB Audio Offload Research <research@audioreach-usb-offload>
Date: Tue, 25 Feb 2026 00:00:00 +0000
Subject: [PATCH 5/6] arm64: dts: qcom: qcs6490-rb3gen2: add USB audio offload
 support under AudioReach

Add q6usb node under the GPR service tree and a USB DAI link to the
sound card on the QCS6490 RB3Gen2 (Radxa Q6A) board.

The upstream qcs6490-audioreach.dtsi defines the GPR stack with q6apm
and q6prm services but has no USB offload support. The q6usb node is
added as a child of the GPR node (not under q6apm) because it registers
as an independent ASoC component via "qcom,q6usb" compatible.

The USB DAI link connects:
  - cpu: q6apmbedai USB_RX (id=136, already defined in q6dsp-lpass-ports)
  - codec: q6usb USB_RX (the USB backend DAI)
  - platform: q6apm (AudioReach graph manager)

This mirrors the Fairphone 5 (QCM6490) USB offload setup but adapted
for the AudioReach/GPR stack instead of APR/AFE.

The IOMMU stream ID 0x1801 matches the existing q6apmdai configuration
in qcs6490-audioreach.dtsi. The USB audio interrupt index 2 is the
standard value for SC7280-family platforms.

Signed-off-by: USB Audio Offload Research <research@audioreach-usb-offload>
---
 .../boot/dts/qcom/qcs6490-rb3gen2-usb-offload.dtso | 60 +++++++++++++++
 1 file changed, 60 insertions(+)
 create mode 100644 arch/arm64/boot/dts/qcom/qcs6490-rb3gen2-usb-offload.dtso

diff --git a/arch/arm64/boot/dts/qcom/qcs6490-rb3gen2-usb-offload.dtso b/arch/arm64/boot/dts/qcom/qcs6490-rb3gen2-usb-offload.dtso
new file mode 100644
index 0000000..XXXXXXX
--- /dev/null
+++ b/arch/arm64/boot/dts/qcom/qcs6490-rb3gen2-usb-offload.dtso
@@ -0,0 +1,60 @@
+// SPDX-License-Identifier: BSD-3-Clause
+/*
+ * QCS6490 RB3Gen2 (Radxa Q6A) - USB Audio Offload under AudioReach/GPR
+ *
+ * This overlay adds USB audio offload support to the existing
+ * AudioReach/GPR audio stack. Apply on top of qcs6490-rb3gen2.dts.
+ *
+ * Prerequisites (kernel patches):
+ *   - audioreach.h: MODULE_ID_USB_AUDIO_SINK/SOURCE added
+ *   - audioreach.c: USB module media format handler added
+ *   - q6apm-lpass-dais.c: USB DAI ops wired up
+ *   - q6usb.c: decoupled from q6afe.h hard dependency
+ */
+
+/*
+ * Add q6usb node under the GPR service tree.
+ *
+ * In the upstream qcs6490-audioreach.dtsi, the GPR node is at:
+ *   &remoteproc_adsp_glink -> gpr { q6apm, q6prm }
+ *
+ * q6usb registers as an independent component (not a child of q6apm).
+ * It needs to be a sibling of q6apm under the gpr node.
+ */
+&remoteproc_adsp_glink {
+	gpr {
+		q6usb: usb-dai {
+			compatible = "qcom,q6usb";
+			#sound-dai-cells = <1>;
+			qcom,usb-audio-intr-idx = /bits/ 16 <2>;
+			iommus = <&apps_smmu 0x1801 0x0>;
+		};
+	};
+};
+
+/*
+ * Add USB DAI link to the sound card.
+ *
+ * The existing sound card has:
+ *   - wsa-dai-link: WSA speakers via CODEC DMA
+ *   - va-dai-link: VA mic capture via CODEC DMA
+ *
+ * We add:
+ *   - usb-dai-link: USB audio playback via USB offload
+ */
+&sound {
+	usb-dai-link {
+		link-name = "USB Playback";
+
+		cpu {
+			sound-dai = <&q6apmbedai USB_RX>;
+		};
+
+		codec {
+			sound-dai = <&q6usb USB_RX>;
+		};
+
+		platform {
+			sound-dai = <&q6apm>;
+		};
+	};
+};

--
2.43.0
