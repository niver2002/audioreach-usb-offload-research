From: USB Audio Offload Research <research@audioreach-usb-offload>
Date: Tue, 25 Feb 2026 00:00:00 +0000
Subject: [PATCH 2/6] ASoC: qdsp6: audioreach: add USB audio module media
 format support

Add audioreach_usb_set_media_format() to configure USB audio sink/source
modules in AudioReach graphs. The function sends three parameter blocks
to the ADSP via GPR/APM:

  1. PARAM_ID_HW_EP_MF_CFG - hardware endpoint media format (sample rate,
     bit width, channels, data format)
  2. PARAM_ID_HW_EP_FRAME_SIZE_FACTOR - frame size factor (set to 1)
  3. PARAM_ID_USB_AUDIO_INTF_CFG - USB-specific interface config (device
     token and service interval)

This follows the same pattern as audioreach_codec_dma_set_media_format()
and audioreach_display_port_set_media_format().

The USB audio data path itself uses QMI (independent of APR/GPR), but
the audio graph configuration (module instantiation, connection, media
format) goes through GPR/APM. The ADSP firmware on QCS6490 already
contains the USB audio modules (capi_usb.c, usb_afe.c) registered with
MODULE_ID_USB_AUDIO_SINK (0x0700104F).

Wire up MODULE_ID_USB_AUDIO_SINK and MODULE_ID_USB_AUDIO_SOURCE in the
audioreach_set_media_format() switch statement.

Signed-off-by: USB Audio Offload Research <research@audioreach-usb-offload>
---
 sound/soc/qcom/qdsp6/audioreach.c | 55 ++++++++++++++++++++++++++++++
 1 file changed, 55 insertions(+)

diff --git a/sound/soc/qcom/qdsp6/audioreach.c b/sound/soc/qcom/qdsp6/audioreach.c
index XXXXXXX..XXXXXXX 100644
--- a/sound/soc/qcom/qdsp6/audioreach.c
+++ b/sound/soc/qcom/qdsp6/audioreach.c
@@ -XXX,6 +XXX,52 @@ static int audioreach_codec_dma_set_media_format(...)
 	return q6apm_send_cmd_sync(graph->apm, pkt, 0);
 }

+/* USB Audio Module Media Format Setup */
+static int audioreach_usb_set_media_format(struct q6apm_graph *graph,
+					   const struct audioreach_module *module,
+					   const struct audioreach_module_config *cfg)
+{
+	struct apm_usb_module_intf_cfg *intf_cfg;
+	struct apm_module_frame_size_factor_cfg *fs_cfg;
+	struct apm_module_param_data *param_data;
+	struct apm_module_hw_ep_mf_cfg *hw_cfg;
+	int ic_sz = APM_USB_INTF_CFG_PSIZE;
+	int ep_sz = APM_HW_EP_CFG_PSIZE;
+	int fs_sz = APM_FS_CFG_PSIZE;
+	int size = ic_sz + ep_sz + fs_sz;
+	void *p;
+
+	struct gpr_pkt *pkt __free(kfree) =
+		audioreach_alloc_apm_cmd_pkt(size, APM_CMD_SET_CFG, 0);
+	if (IS_ERR(pkt))
+		return PTR_ERR(pkt);
+
+	p = (void *)pkt + GPR_HDR_SIZE + APM_CMD_HDR_SIZE;
+
+	/* Hardware endpoint media format */
+	hw_cfg = p;
+	param_data = &hw_cfg->param_data;
+	param_data->module_instance_id = module->instance_id;
+	param_data->error_code = 0;
+	param_data->param_id = PARAM_ID_HW_EP_MF_CFG;
+	param_data->param_size = ep_sz - APM_MODULE_PARAM_DATA_SIZE;
+	hw_cfg->mf.sample_rate = cfg->sample_rate;
+	hw_cfg->mf.bit_width = cfg->bit_width;
+	hw_cfg->mf.num_channels = cfg->num_channels;
+	hw_cfg->mf.data_format = module->data_format;
+	p += ep_sz;
+
+	/* Frame size factor */
+	fs_cfg = p;
+	param_data = &fs_cfg->param_data;
+	param_data->module_instance_id = module->instance_id;
+	param_data->error_code = 0;
+	param_data->param_id = PARAM_ID_HW_EP_FRAME_SIZE_FACTOR;
+	param_data->param_size = fs_sz - APM_MODULE_PARAM_DATA_SIZE;
+	fs_cfg->frame_size_factor = 1;
+	p += fs_sz;
+
+	/* USB audio interface config */
+	intf_cfg = p;
+	param_data = &intf_cfg->param_data;
+	param_data->module_instance_id = module->instance_id;
+	param_data->error_code = 0;
+	param_data->param_id = PARAM_ID_USB_AUDIO_INTF_CFG;
+	param_data->param_size = ic_sz - APM_MODULE_PARAM_DATA_SIZE;
+	intf_cfg->cfg.usb_token = cfg->usb_token;
+	intf_cfg->cfg.svc_interval = cfg->usb_svc_interval;
+
+	return q6apm_send_cmd_sync(graph->apm, pkt, 0);
+}
+
 int audioreach_set_media_format(struct q6apm_graph *graph,
 				const struct audioreach_module *module,
 				const struct audioreach_module_config *cfg)
@@ -XXX,6 +XXX,9 @@ int audioreach_set_media_format(...)
 	case MODULE_ID_CODEC_DMA_SOURCE:
 		rc = audioreach_codec_dma_set_media_format(graph, module, cfg);
 		break;
+	case MODULE_ID_USB_AUDIO_SINK:
+	case MODULE_ID_USB_AUDIO_SOURCE:
+		rc = audioreach_usb_set_media_format(graph, module, cfg);
+		break;
 	case MODULE_ID_SAL:
 		rc = audioreach_sal_set_media_format(graph, module, cfg);

--
2.43.0
