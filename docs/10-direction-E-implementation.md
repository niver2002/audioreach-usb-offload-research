# 方向E 实现方案：AudioReach/GPR 栈下的 USB Audio Offload

## 概述

在 QCS6490 (Radxa Q6A) 的 AudioReach/GPR 音频栈下实现 USB audio offload。
核心思路：ADSP 固件已内置完整 USB offload 支持，QMI 数据通道独立于 APR/GPR，
只需在内核侧补齐 AudioReach 图配置路径。

## 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    用户空间                               │
│  PipeWire/PulseAudio → ALSA PCM → ASoC sound card       │
└──────────────────────────┬──────────────────────────────┘
                           │
┌──────────────────────────┼──────────────────────────────┐
│                     内核空间                              │
│                          │                               │
│  ┌───────────────────────▼────────────────────────────┐  │
│  │ Sound Card (qcom,qcs6490-rb3gen2-sndcard)          │  │
│  │  ├─ wsa-dai-link: WSA speakers (existing)          │  │
│  │  ├─ va-dai-link: VA capture (existing)             │  │
│  │  └─ usb-dai-link: USB Playback (NEW)               │  │
│  │       cpu: q6apmbedai USB_RX (id=136)              │  │
│  │       codec: q6usb USB_RX                          │  │
│  │       platform: q6apm                              │  │
│  └────────────────────────────────────────────────────┘  │
│                          │                               │
│         ┌────────────────┼────────────────┐              │
│         │ GPR 路径        │ QMI 路径       │              │
│         ▼                │                ▼              │
│  ┌─────────────┐         │    ┌──────────────────────┐   │
│  │ q6apm.c     │         │    │ qc_audio_offload.c   │   │
│  │ audioreach.c│         │    │ (QMI + XHCI sideband)│   │
│  │ (图配置)     │         │    │ (数据通道)            │   │
│  └──────┬──────┘         │    └──────────┬───────────┘   │
│         │ GPR/glink      │               │ QMI           │
└─────────┼────────────────┼───────────────┼───────────────┘
          │                │               │
┌─────────┼────────────────┼───────────────┼───────────────┐
│         ▼     ADSP 固件   │               ▼               │
│  ┌─────────────┐         │    ┌──────────────────────┐   │
│  │ APM/GPR     │         │    │ usb_qdi_qmi.c        │   │
│  │ 图管理器     │─────────┼───▶│ usb_afe.c            │   │
│  │             │         │    │ usb_xhcd.c           │   │
│  └─────────────┘         │    └──────────┬───────────┘   │
│  MODULE_ID_USB_AUDIO_SINK│               │ XHCI sideband │
│  (0x0700104F)            │               │               │
└──────────────────────────┼───────────────┼───────────────┘
                           │               │
                           │    ┌──────────▼───────────┐
                           │    │ USB XHCI 控制器       │
                           │    │ Transfer Ring (DMA)   │
                           │    └──────────┬───────────┘
                           │               │
                           │    ┌──────────▼───────────┐
                           │    │ USB 音频设备           │
                           │    │ (耳机/DAC/音箱)       │
                           │    └──────────────────────┘
```

## 补丁清单 (patches/)

| # | 文件 | 改什么 | 为什么 |
|---|------|--------|--------|
