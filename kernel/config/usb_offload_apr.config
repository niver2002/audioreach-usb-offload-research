# ============================================
# QCS6490 USB Audio Offload - APR 栈内核配置
# ============================================
# 专用于 APR/AFE 路径的 USB Audio Offload
# 配合 qcs6490-radxa-q6a-usb-offload-apr.dts 使用
#
# 使用方法:
#   cd <kernel-source>
#   ./scripts/kconfig/merge_config.sh \
#       arch/arm64/configs/defconfig \
#       usb_offload_apr.config
#   make olddefconfig
#   make -j$(nproc)
# ============================================

# ============================================
# 1. Qualcomm 平台基础
# ============================================

CONFIG_ARCH_QCOM=y

# Remoteproc - ADSP 固件加载
CONFIG_REMOTEPROC=y
CONFIG_QCOM_Q6V5_ADSP=m
CONFIG_QCOM_Q6V5_PAS=m

# 进程间通信
CONFIG_QCOM_SMEM=y
CONFIG_QCOM_SMP2P=y
CONFIG_RPMSG=y
CONFIG_RPMSG_QCOM_GLINK=y
CONFIG_RPMSG_QCOM_GLINK_SMEM=y

# APR - Audio Platform Router（关键：APR 栈的基础）
CONFIG_QCOM_APR=m

# QMI - USB offload 控制通道
CONFIG_QCOM_QMI_HELPERS=m

# ============================================
# 2. USB 子系统
# ============================================

CONFIG_USB_SUPPORT=y
CONFIG_USB=y

# XHCI 主机控制器
CONFIG_USB_XHCI_HCD=y
CONFIG_USB_XHCI_PLATFORM=y

# XHCI Sideband（关键：ADSP 直接操作 USB transfer ring）
CONFIG_USB_XHCI_SIDEBAND=y

# DWC3 控制器 (QCS6490)
CONFIG_USB_DWC3=y
CONFIG_USB_DWC3_QCOM=y

# 标准 USB Audio（fallback 路径）
CONFIG_SND_USB_AUDIO=m

# ============================================
# 3. ALSA / ASoC 核心
# ============================================

CONFIG_SOUND=y
CONFIG_SND=y
CONFIG_SND_SOC=y

# Auxiliary Bus（q6usb 依赖）
CONFIG_AUXILIARY_BUS=y

# ============================================
# 4. Qualcomm QDSP6 音频驱动 - APR 栈
# ============================================

# QDSP6 主驱动（自动拉入 AFE/ASM/ADM/CORE）
CONFIG_SND_SOC_QDSP6=m

# Q6USB - USB offload 后端 DAI（关键）
# 依赖 SND_SOC_USB，自动 select SND_SOC_QCOM_OFFLOAD_UTILS
CONFIG_SND_SOC_QDSP6_USB=m

# SoC USB 框架
CONFIG_SND_SOC_USB=m

# ============================================
# 5. 机器驱动
# ============================================

# SC8280XP 机器驱动（Radxa Q6A 使用）
# 需要应用 sc8280xp-usb-offload.patch
CONFIG_SND_SOC_SC8280XP=m

# Qualcomm 通用音频工具
CONFIG_SND_SOC_QCOM_COMMON=m
CONFIG_SND_SOC_QCOM_SDW=m

# ============================================
# 6. Codec 驱动
# ============================================

# SoundWire 总线
CONFIG_SOUNDWIRE=y
CONFIG_SOUNDWIRE_QCOM=m

# WCD938x Codec
CONFIG_SND_SOC_WCD938X=m
CONFIG_SND_SOC_WCD938X_SDW=m

# LPASS Codec Macros (SC7280/QCS6490)
CONFIG_SND_SOC_SC7280=m

# ============================================
# 7. IOMMU（ADSP DMA 访问 USB 控制器）
# ============================================

CONFIG_IOMMU_SUPPORT=y
CONFIG_ARM_SMMU=y
CONFIG_QCOM_IOMMU=y

# ============================================
# 8. 时钟和电源
# ============================================

CONFIG_COMMON_CLK=y
CONFIG_COMMON_CLK_QCOM=y
CONFIG_CLK_RPMH=y

# ============================================
# 说明
# ============================================
#
# APR 栈模块加载顺序:
#   1. qcom_q6v5_pas (加载 ADSP 固件)
#   2. qcom_apr (APR 协议栈)
#   3. snd-soc-qdsp6-core (q6core)
#   4. snd-soc-qdsp6-afe (q6afe + q6afe-dai + q6afe-clocks)
#   5. snd-soc-qdsp6-asm (q6asm + q6asm-dai)
#   6. snd-soc-qdsp6-adm (q6adm + q6routing)
#   7. snd-soc-qdsp6-usb (q6usb)
#   8. snd-usb-audio (标准 USB audio + offload 扩展)
#   9. snd-sc8280xp (机器驱动)
#
# 与 AudioReach 配置的区别:
#   - 使用 CONFIG_QCOM_APR 而非 CONFIG_QCOM_GPR
#   - 使用 q6afe/q6asm/q6adm 而非 q6apm/q6prm
#   - 新增 CONFIG_SND_SOC_QDSP6_USB
#   - 新增 CONFIG_SND_SOC_USB
#   - 新增 CONFIG_USB_XHCI_SIDEBAND
#
# 验证:
#   cat /sys/bus/apr/devices/*/modalias  # APR 服务已注册
#   cat /proc/asound/cards               # 声卡已创建
#   aplay -l                             # 列出 PCM 设备（应含 USB）
#
