# ============================================
# QCS6490 USB Audio Offload 内核配置
# ============================================
# 使用方法:
#   ./scripts/kconfig/merge_config.sh arch/arm64/configs/qcs6490_defconfig \
#       usb_audio_offload.config
# ============================================

# --- Qualcomm 平台基础 ---
# Qualcomm SoC 架构支持
CONFIG_ARCH_QCOM=y

# Remoteproc 框架 - 用于加载和管理 DSP 固件
CONFIG_REMOTEPROC=y
CONFIG_QCOM_RPROC_COMMON=y
CONFIG_QCOM_Q6V5_COMMON=y
CONFIG_QCOM_Q6V5_ADSP=y
CONFIG_QCOM_Q6V5_PAS=y

# SMEM - 共享内存接口
CONFIG_QCOM_SMEM=y
CONFIG_QCOM_SMP2P=y
CONFIG_QCOM_SMSM=y

# --- 通信层 ---
# GLINK - Qualcomm 进程间通信
CONFIG_RPMSG=y
CONFIG_RPMSG_QCOM_GLINK=y
CONFIG_RPMSG_QCOM_GLINK_RPM=y
CONFIG_RPMSG_QCOM_GLINK_SMEM=y

# APR/GPR - 音频路由协议
CONFIG_QCOM_APR=y
CONFIG_QCOM_GPR=y

# QMI - Qualcomm MSM Interface (用于 USB offload 控制)
CONFIG_QCOM_QMI_HELPERS=y

# --- AudioReach 框架 ---
# ALSA SoC 核心
CONFIG_SOUND=y
CONFIG_SND=y
CONFIG_SND_SOC=y

# Qualcomm QDSP6 音频子系统
CONFIG_SND_SOC_QCOM=y
CONFIG_SND_SOC_QDSP6=y

# AudioReach 核心组件
CONFIG_SND_SOC_QDSP6_CORE=y
CONFIG_SND_SOC_QDSP6_APM=y
CONFIG_SND_SOC_QDSP6_PRM=y
CONFIG_SND_SOC_QDSP6_AFE=y
CONFIG_SND_SOC_QDSP6_AFE_DAI=y
CONFIG_SND_SOC_QDSP6_AFE_CLOCKS=y

# AudioReach DAI 驱动
CONFIG_SND_SOC_QDSP6_Q6APM_DAI=y
CONFIG_SND_SOC_QDSP6_Q6APM_LPASS_DAI=y

# --- USB Audio Offload 核心 ---
# Q6USB - ADSP USB 音频前端
CONFIG_SND_SOC_QDSP6_Q6USB=y

# USB Audio QMI - 用于 ADSP 和 USB 驱动通信
CONFIG_SND_USB_AUDIO_QMI=y

# SoC USB 框架 - 连接 ALSA 和 USB 子系统
CONFIG_SND_SOC_USB=y

# XHCI Sideband - 允许 ADSP 直接访问 USB 端点
CONFIG_USB_XHCI_SIDEBAND=y

# --- USB 子系统 ---
# USB 核心支持
CONFIG_USB_SUPPORT=y
CONFIG_USB=y
CONFIG_USB_ANNOUNCE_NEW_DEVICES=y

# XHCI (USB 3.0) 主机控制器
CONFIG_USB_XHCI_HCD=y
CONFIG_USB_XHCI_PLATFORM=y

# DWC3 USB 控制器 (Qualcomm 使用)
CONFIG_USB_DWC3=y
CONFIG_USB_DWC3_HOST=y
CONFIG_USB_DWC3_QCOM=y

# USB Audio Class 驱动 (传统路径，作为 fallback)
CONFIG_SND_USB_AUDIO=y

# --- IOMMU 支持 ---
# IOMMU 框架 - 用于 ADSP 访问 USB 内存
CONFIG_IOMMU_SUPPORT=y
CONFIG_IOMMU_API=y
CONFIG_ARM_SMMU=y
CONFIG_ARM_SMMU_V3=y
CONFIG_QCOM_IOMMU=y

# DMA 映射
CONFIG_DMA_SHARED_BUFFER=y
CONFIG_DMA_CMA=y

# --- 设备树支持 ---
CONFIG_OF=y
CONFIG_OF_RESERVED_MEM=y
CONFIG_OF_ADDRESS=y

# --- 固件加载 ---
CONFIG_FW_LOADER=y
CONFIG_FW_LOADER_USER_HELPER=y
CONFIG_EXTRA_FIRMWARE=""

# --- 调试选项 (开发时启用) ---
# 动态调试 - 运行时控制日志级别
# CONFIG_DYNAMIC_DEBUG=y

# QDSP6 调试
# CONFIG_SND_SOC_QDSP6_DEBUG=y

# USB 调试
# CONFIG_USB_DEBUG=y
# CONFIG_USB_XHCI_HCD_DEBUGGING=y

# Remoteproc 调试
# CONFIG_REMOTEPROC_CDEV=y

# IOMMU 调试
# CONFIG_IOMMU_DEBUG=y
# CONFIG_IOMMU_DEBUGFS=y

# Debugfs 文件系统
CONFIG_DEBUG_FS=y

# Tracing 支持
CONFIG_FTRACE=y
CONFIG_FUNCTION_TRACER=y
CONFIG_DYNAMIC_FTRACE=y

# --- 性能优化 ---
# 高分辨率定时器 - 降低音频延迟
CONFIG_HIGH_RES_TIMERS=y
CONFIG_NO_HZ_FULL=y

# CPU 频率调节
CONFIG_CPU_FREQ=y
CONFIG_CPU_FREQ_GOV_PERFORMANCE=y
CONFIG_CPU_FREQ_GOV_ONDEMAND=y

# CPU 空闲管理
CONFIG_CPU_IDLE=y
CONFIG_ARM_CPUIDLE=y

# --- 电源管理 ---
CONFIG_PM=y
CONFIG_PM_SLEEP=y
CONFIG_PM_RUNTIME=y
CONFIG_PM_GENERIC_DOMAINS=y
CONFIG_QCOM_RPM_MASTER_STATS=y

# --- 其他依赖 ---
# Regmap - 寄存器访问抽象层
CONFIG_REGMAP=y
CONFIG_REGMAP_MMIO=y

# 时钟框架
CONFIG_COMMON_CLK=y
CONFIG_COMMON_CLK_QCOM=y

# Pinctrl - 引脚复用控制
CONFIG_PINCTRL=y
CONFIG_PINCTRL_QCOM=y

# 中断控制器
CONFIG_ARM_GIC=y
CONFIG_ARM_GIC_V3=y

# ============================================
# 可选功能
# ============================================

# --- 多声道支持 ---
# 支持 5.1/7.1 环绕声
CONFIG_SND_PCM_OSS=y
CONFIG_SND_MIXER_OSS=y

# --- 压缩音频 ---
# 支持 MP3/AAC 等压缩格式的硬件解码
# CONFIG_SND_COMPRESS_OFFLOAD=y

# --- ALSA 拓扑 ---
# 动态音频拓扑配置
CONFIG_SND_SOC_TOPOLOGY=y

# --- 音频效果 ---
# DSP 音频效果处理
# CONFIG_SND_SOC_QDSP6_EFFECTS=y

# ============================================
# 注意事项
# ============================================
# 1. 确保 ADSP 固件文件存在于 /lib/firmware/qcom/qcs6490/
# 2. 设备树必须正确配置 USB sideband 和 IOMMU
# 3. 某些选项可能需要专有固件或驱动
# 4. 调试选项会增加内核大小和降低性能，生产环境应禁用
