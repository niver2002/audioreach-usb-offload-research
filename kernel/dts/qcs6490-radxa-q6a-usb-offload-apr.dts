// SPDX-License-Identifier: BSD-3-Clause
/*
 * Copyright (c) 2025 - USB Audio Offload Research Project
 *
 * Radxa Q6A (QCS6490) - APR Audio Stack with USB Offload
 *
 * This is a VERIFICATION DTS overlay that switches the Radxa Q6A from
 * AudioReach (GPR/q6apm) to APR (q6afe/q6asm/q6adm) audio stack,
 * enabling USB audio offload via ADSP.
 *
 * Key difference from upstream qcs6490-radxa-dragon-q6a.dts:
 *   - Does NOT include qcs6490-audioreach.dtsi
 *   - Uses kodiak.dtsi's native APR stack (q6afe, q6asm, q6adm, q6usb)
 *   - LPASS macros use q6afecc clocks instead of q6prmcc
 *   - LPASS macros retain power-domains from kodiak.dtsi
 *   - Sound card uses q6afedai/q6routing instead of q6apmbedai/q6apm
 *   - Adds USB DAI link for offload playback
 *
 * Reference: qcm6490-fairphone-fp5.dts (same SoC, USB offload working)
 *
 * IMPORTANT: This requires ADSP firmware that supports APR protocol.
 *            Run scripts/verify-apr-firmware.sh on device first.
 */

/dts-v1/;

/*
 * Include the base SoC dtsi (kodiak.dtsi) which contains the APR stack:
 *   apr { q6afe, q6asm, q6adm, q6usbdai }
 *
 * We intentionally do NOT include qcs6490-audioreach.dtsi which would
 * delete the APR node and replace it with GPR.
 */
#include <dt-bindings/iio/qcom,spmi-adc7-pmk8350.h>
#include <dt-bindings/iio/qcom,spmi-adc7-pm7325.h>
#include <dt-bindings/leds/common.h>
#include <dt-bindings/pinctrl/qcom,pmic-gpio.h>
#include <dt-bindings/regulator/qcom,rpmh-regulator.h>
#include <dt-bindings/sound/qcom,q6asm.h>
#include <dt-bindings/sound/qcom,q6dsp-lpass-ports.h>
#include "kodiak.dtsi"
#include "pm7250b.dtsi"
#include "pm7325.dtsi"
#include "pm8350c.dtsi"
#include "pmk8350.dtsi"

/* NOTE: qcs6490-audioreach.dtsi is NOT included - this is intentional */

/ {
	model = "Radxa Dragon Q6A (APR/USB-Offload)";
	compatible = "radxa,dragon-q6a", "qcom,qcs6490";

	/*
	 * WCD938x audio codec - identical to upstream Radxa Q6A config.
	 * Connected via SoundWire (SWR0 for RX, SWR1 for TX).
	 */
	wcd938x: audio-codec {
		compatible = "qcom,wcd9380-codec";

		pinctrl-0 = <&wcd_default>;
		pinctrl-names = "default";

		reset-gpios = <&tlmm 83 GPIO_ACTIVE_LOW>;

		vdd-rxtx-supply = <&vreg_l18b_1p8>;
		vdd-io-supply = <&vreg_l18b_1p8>;
		vdd-buck-supply = <&vreg_l17b_1p8>;
		vdd-mic-bias-supply = <&vreg_bob_3p296>;

		qcom,micbias1-microvolt = <1800000>;
		qcom,micbias2-microvolt = <1800000>;
		qcom,micbias3-microvolt = <1800000>;
		qcom,micbias4-microvolt = <1800000>;
		qcom,mbhc-buttons-vthreshold-microvolt =
			<75000 150000 237000 500000 500000 500000 500000 500000>;
		qcom,mbhc-headset-vthreshold-microvolt = <1700000>;
		qcom,mbhc-headphone-vthreshold-microvolt = <50000>;
		qcom,rx-device = <&wcd_rx>;
		qcom,tx-device = <&wcd_tx>;

		qcom,hphl-jack-type-normally-closed;

		#sound-dai-cells = <1>;
	};

	chosen {
		stdout-path = "serial0:115200n8";
	};
};

/*
 * ============================================================
 * Sound Card Definition - APR Stack with USB Offload
 * ============================================================
 *
 * Key changes from upstream (AudioReach) Radxa Q6A:
 *   - compatible: same sc8280xp machine driver (needs USB patch)
 *   - cpu DAIs: q6afedai instead of q6apmbedai
 *   - platform: q6routing instead of q6apm
 *   - Added: MultiMedia1 frontend (q6asmdai)
 *   - Added: USB Playback DAI link (q6usbdai + q6afedai)
 */
&sound {
	compatible = "qcom,qcs6490-rb3gen2-sndcard";
	model = "QCS6490-Radxa-Dragon-Q6A-APR";

	audio-routing = "IN1_HPHL", "HPHL_OUT",
			"IN2_HPHR", "HPHR_OUT",
			"AMIC2", "MIC BIAS2",
			"TX SWR_ADC1", "ADC2_OUTPUT";

	/* Frontend: MultiMedia1 (required for APR audio path) */
	mm1-dai-link {
		link-name = "MultiMedia1";

		cpu {
			sound-dai = <&q6asmdai MSM_FRONTEND_DAI_MULTIMEDIA1>;
		};
	};

	/* Backend: WCD938x Playback via CODEC DMA */
	wcd-playback-dai-link {
		link-name = "WCD Playback";

		codec {
			sound-dai = <&wcd938x 0>, <&swr0 0>, <&lpass_rx_macro 0>;
		};

		cpu {
			sound-dai = <&q6afedai RX_CODEC_DMA_RX_0>;
		};

		platform {
			sound-dai = <&q6routing>;
		};
	};

	/* Backend: WCD938x Capture via CODEC DMA */
	wcd-capture-dai-link {
		link-name = "WCD Capture";

		codec {
			sound-dai = <&wcd938x 1>, <&swr1 0>, <&lpass_tx_macro 0>;
		};

		cpu {
			sound-dai = <&q6afedai TX_CODEC_DMA_TX_3>;
		};

		platform {
			sound-dai = <&q6routing>;
		};
	};

	/* Backend: USB Audio Offload Playback */
	usb-dai-link {
		link-name = "USB Playback";

		codec {
			sound-dai = <&q6usbdai USB_RX>;
		};

		cpu {
			sound-dai = <&q6afedai USB_RX>;
		};

		platform {
			sound-dai = <&q6routing>;
		};
	};
};

/*
 * ============================================================
 * Hardware Nodes
 * ============================================================
 *
 * The following sections are identical to the upstream Radxa Q6A DTS.
 * Only the sound card and audio stack differ (APR vs AudioReach).
 *
 * NOTE: LPASS macros are NOT overridden here. They use kodiak.dtsi
 * defaults which reference q6afecc clocks and have power-domains.
 * The qcs6490-audioreach.dtsi overlay would have changed these to
 * q6prmcc and removed power-domains, but we skip that overlay.
 */

&remoteproc_adsp {
	/*
	 * CRITICAL: This firmware must support APR protocol.
	 * If it only supports GPR, USB offload will not work.
	 * Run scripts/verify-apr-firmware.sh to check.
	 */
	firmware-name = "qcom/qcs6490/radxa/dragon-q6a/adsp.mbn";
	status = "okay";
};

&remoteproc_cdsp {
	firmware-name = "qcom/qcs6490/cdsp.mbn";
	status = "okay";
};

/* SoundWire RX (playback path to WCD938x) */
&swr0 {
	status = "okay";

	wcd_rx: codec@0,4 {
		compatible = "sdw20217010d00";
		reg = <0 4>;
		qcom,rx-port-mapping = <1 2 3 4 5>;
	};
};

/* SoundWire TX (capture path from WCD938x) */
&swr1 {
	status = "okay";

	wcd_tx: codec@0,3 {
		compatible = "sdw20217010d00";
		reg = <0 3>;
		qcom,tx-port-mapping = <1 1 2 3>;
	};
};

/*
 * USB controllers - required for USB audio offload.
 * The XHCI sideband interface allows ADSP to directly
 * operate USB transfer rings for isochronous audio.
 */
&usb_1 {
	status = "okay";
};

&usb_1_dwc3 {
	dr_mode = "host";
};

&usb_1_hsphy {
	vdda-pll-supply = <&vreg_l10c_0p88>;
	vdda33-supply = <&vreg_l2b_3p072>;
	vdda18-supply = <&vreg_l1c_1p8>;
	status = "okay";
};

&usb_1_qmpphy {
	vdda-phy-supply = <&vreg_l6b_1p2>;
	vdda-pll-supply = <&vreg_l1b_0p912>;
	status = "okay";
};

&usb_2 {
	status = "okay";
};

&usb_2_dwc3 {
	dr_mode = "host";
};

&usb_2_hsphy {
	vdda-pll-supply = <&vreg_l10c_0p88>;
	vdda33-supply = <&vreg_l2b_3p072>;
	vdda18-supply = <&vreg_l1c_1p8>;
	status = "okay";
};

/*
 * NOTE: The rest of the hardware configuration (regulators, GPIO,
 * display, PCIe, I2C, SPI, etc.) is identical to the upstream
 * qcs6490-radxa-dragon-q6a.dts and should be copied from there.
 *
 * This file focuses on the audio stack changes for USB offload
 * verification. For a complete bootable DTS, merge the remaining
 * nodes from the upstream file.
 *
 * Key sections to copy from upstream:
 *   - &apps_rsc { regulators }
 *   - &gpi_dma0, &gpi_dma1
 *   - &gpu, &mdss, &mdss_dp, &mdss_dsi0
 *   - &i2c0..&i2c14
 *   - &pcie1, &pcie1_phy
 *   - &pm7250b_*, &pm7325_*, &pmk8350_*
 *   - &qupv3_id_0, &qupv3_id_1
 *   - &sdhc_1, &sdhc_2
 *   - &tlmm, &uart5
 *   - &wifi
 */
